<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QUITUS Pay - Portail Marchand</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap');
        
        * { font-family: 'DM Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        h1, h2, h3, .font-display { font-family: 'Space Grotesk', sans-serif; }
        
        :root {
            --quitus-dark: #1a2e0a;
            --quitus-primary: #2d4a0f;
            --merchant-purple: #6b21a8;
            --merchant-light: #f3e8ff;
        }
        
        .bg-gradient-merchant { background: linear-gradient(135deg, #581c87 0%, #7c3aed 100%); }
        .bg-gradient-quitus { background: linear-gradient(135deg, var(--quitus-dark) 0%, var(--quitus-primary) 100%); }
        
        .input-field:focus { border-color: var(--merchant-purple); box-shadow: 0 0 0 3px rgba(107, 33, 168, 0.1); }
        .card-shadow { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
        
        .btn-merchant {
            background: linear-gradient(135deg, #581c87 0%, #7c3aed 100%);
            transition: all 0.3s ease;
        }
        .btn-merchant:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(107, 33, 168, 0.4); }
        .btn-merchant:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .otp-input {
            width: 48px; height: 56px; text-align: center; font-size: 24px; font-weight: 700;
            border: 2px solid #e5e7eb; border-radius: 12px; transition: all 0.2s ease;
        }
        .otp-input:focus { border-color: var(--merchant-purple); outline: none; }
        .otp-input.filled { border-color: var(--merchant-purple); background: var(--merchant-light); }
        
        .slide-up { animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .success-animation { animation: successPop 0.5s ease-out; }
        @keyframes successPop { 0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        
        .pending-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .nav-item.active { color: var(--quitus-primary); }
        .nav-item.active .nav-icon { background: #e8f5e9; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-md mx-auto min-h-screen bg-white shadow-2xl relative pb-24">
        
        <!-- Header -->
        <div class="bg-gradient-merchant text-white p-5 pb-8">
            <div class="flex items-center justify-between mb-6">
                <button onclick="goBack()" class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h1 class="font-bold text-lg font-display" data-i18n="merchantPortal">Portail Marchand</h1>
                <button class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-bell"></i>
                </button>
            </div>
            
            <!-- Merchant Info -->
            <div class="flex items-center space-x-4">
                <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center">
                    <i class="fas fa-store text-purple-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-white/70 text-sm" data-i18n="businessName">Nom commercial</p>
                    <p class="font-bold text-lg">Boutique Astrid</p>
                    <p class="text-white/70 text-xs">ID: MRC-2024-0891</p>
                </div>
            </div>
        </div>
        
        <!-- Stats Cards -->
        <div class="px-5 -mt-4 mb-6">
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white rounded-2xl p-4 card-shadow">
                    <p class="text-gray-500 text-xs mb-1" data-i18n="todayCollections">Collectes aujourd'hui</p>
                    <p class="font-bold text-xl font-display text-gray-800">125,000</p>
                    <p class="text-gray-400 text-xs">XAF</p>
                </div>
                <div class="bg-white rounded-2xl p-4 card-shadow">
                    <p class="text-gray-500 text-xs mb-1" data-i18n="transactions">Transactions</p>
                    <p class="font-bold text-xl font-display text-gray-800">12</p>
                    <p class="text-green-500 text-xs"><i class="fas fa-arrow-up mr-1"></i>+3 <span data-i18n="today">aujourd'hui</span></p>
                </div>
            </div>
        </div>
        
        <!-- Collect Payment Section -->
        <div id="collectSection" class="px-5 mb-6 slide-up">
            <h2 class="font-bold text-gray-800 font-display mb-4" data-i18n="collectPayment">Collecter un paiement</h2>
            
            <div class="bg-white rounded-2xl p-5 card-shadow">
                <!-- Customer Phone -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="customerPhone">T√©l√©phone du client</label>
                    <div class="flex">
                        <div class="flex items-center px-4 bg-gray-100 border-2 border-r-0 border-gray-200 rounded-l-xl">
                            <img src="https://flagcdn.com/w20/cm.png" class="w-5 h-4 mr-2" alt="CM">
                            <span class="text-gray-600 font-medium">+237</span>
                        </div>
                        <input type="tel" id="customerPhone" placeholder="6XX XXX XXX" 
                            class="input-field flex-1 px-4 py-3 border-2 border-gray-200 rounded-r-xl focus:outline-none text-lg"
                            maxlength="9" oninput="validateCollectForm()">
                    </div>
                </div>
                
                <!-- Amount -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="amountToCollect">Montant √† collecter (XAF)</label>
                    <input type="number" id="collectAmount" placeholder="0" 
                        class="input-field w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:outline-none text-2xl font-bold text-center"
                        oninput="validateCollectForm()">
                </div>
                
                <!-- Description (optional) -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="description">Description (optionnel)</label>
                    <input type="text" id="collectDescription" placeholder="Ex: Achat de marchandises" 
                        class="input-field w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none"
                        data-i18n-placeholder="descriptionPlaceholder">
                </div>
                
                <button id="collectBtn" onclick="initiateCollection()" disabled 
                    class="btn-merchant w-full text-white py-4 rounded-xl font-semibold text-lg">
                    <i class="fas fa-qrcode mr-2"></i>
                    <span data-i18n="requestPayment">Demander le paiement</span>
                </button>
            </div>
        </div>
        
        <!-- Recent Collections -->
        <div class="px-5 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-bold text-gray-800 font-display" data-i18n="recentCollections">Collectes r√©centes</h2>
                <button class="text-purple-700 text-sm font-medium" data-i18n="viewAll">Tout voir</button>
            </div>
            
            <div class="bg-white rounded-2xl card-shadow overflow-hidden">
                <div class="txn-item p-4 flex items-center justify-between border-b border-gray-100">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-check text-green-500 text-sm"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-800">+237 655 123 456</p>
                            <p class="text-xs text-gray-500">Il y a 5 min</p>
                        </div>
                    </div>
                    <span class="font-bold text-green-500">+15,000 XAF</span>
                </div>
                
                <div class="txn-item p-4 flex items-center justify-between border-b border-gray-100">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-check text-green-500 text-sm"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-800">+237 670 987 654</p>
                            <p class="text-xs text-gray-500">Il y a 1h</p>
                        </div>
                    </div>
                    <span class="font-bold text-green-500">+8,500 XAF</span>
                </div>
                
                <div class="txn-item p-4 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-times text-red-500 text-sm"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-800">+237 691 456 789</p>
                            <p class="text-xs text-gray-500" data-i18n="declined">Refus√© - Il y a 2h</p>
                        </div>
                    </div>
                    <span class="font-bold text-red-500">5,000 XAF</span>
                </div>
            </div>
        </div>
        
        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t shadow-lg z-50">
            <div class="flex justify-around py-2">
                <a href="quitus_pay_home_v2.html" class="nav-item flex flex-col items-center py-2 px-4 text-gray-400">
                    <div class="nav-icon w-10 h-10 rounded-xl flex items-center justify-center mb-1">
                        <i class="fas fa-home text-lg"></i>
                    </div>
                    <span class="text-xs font-medium" data-i18n="home">Accueil</span>
                </a>
                <a href="#" class="nav-item flex flex-col items-center py-2 px-4 text-gray-400">
                    <div class="nav-icon w-10 h-10 rounded-xl flex items-center justify-center mb-1">
                        <i class="fas fa-exchange-alt text-lg"></i>
                    </div>
                    <span class="text-xs font-medium" data-i18n="activity">Activit√©s</span>
                </a>
                <a href="#" class="nav-item active flex flex-col items-center py-2 px-4">
                    <div class="nav-icon w-10 h-10 rounded-xl flex items-center justify-center mb-1 bg-purple-100">
                        <i class="fas fa-store text-lg text-purple-600"></i>
                    </div>
                    <span class="text-xs font-medium text-purple-600" data-i18n="merchant">Marchand</span>
                </a>
                <a href="#" class="nav-item flex flex-col items-center py-2 px-4 text-gray-400">
                    <div class="nav-icon w-10 h-10 rounded-xl flex items-center justify-center mb-1">
                        <i class="fas fa-chart-bar text-lg"></i>
                    </div>
                    <span class="text-xs font-medium" data-i18n="reports">Rapports</span>
                </a>
                <a href="quitus_pay_settings_v2.html" class="nav-item flex flex-col items-center py-2 px-4 text-gray-400">
                    <div class="nav-icon w-10 h-10 rounded-xl flex items-center justify-center mb-1">
                        <i class="fas fa-cog text-lg"></i>
                    </div>
                    <span class="text-xs font-medium" data-i18n="settings">Param√®tres</span>
                </a>
            </div>
        </nav>
    </div>
    
    <!-- Step 1: OTP Verification Modal -->
    <div id="otpModal" class="fixed inset-0 bg-black/50 hidden z-50 items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-md overflow-hidden slide-up">
            <div class="p-6 text-center">
                <!-- Step Indicator -->
                <div class="flex items-center justify-center space-x-2 mb-6">
                    <div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center text-white text-sm font-bold">1</div>
                    <div class="w-8 h-1 bg-gray-200"></div>
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-gray-400 text-sm font-bold">2</div>
                    <div class="w-8 h-1 bg-gray-200"></div>
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-gray-400 text-sm font-bold">
                        <i class="fas fa-check text-xs"></i>
                    </div>
                </div>
                
                <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-shield-alt text-blue-600 text-3xl"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800 font-display mb-2" data-i18n="step1Title">√âtape 1: V√©rification OTP</h2>
                <p class="text-gray-500 mb-2" data-i18n="otpSentToCustomer">Un code OTP a √©t√© envoy√© au client</p>
                <p class="font-bold text-gray-800 text-lg mb-4" id="modalPhone">+237 6XX XXX XXX</p>
                
                <!-- Payment Summary -->
                <div class="bg-gray-50 rounded-xl p-4 mb-6 text-left">
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-500" data-i18n="amount">Montant</span>
                        <span class="font-bold" id="modalAmount">10,000 XAF</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500" data-i18n="description">Description</span>
                        <span class="text-gray-700" id="modalDescription">-</span>
                    </div>
                </div>
                
                <!-- Status -->
                <div id="pendingStatus" class="pending-pulse flex items-center justify-center space-x-2 text-orange-500 mb-6">
                    <i class="fas fa-clock"></i>
                    <span data-i18n="waitingOtp">En attente de la saisie du code OTP...</span>
                </div>
                
                <!-- Customer OTP Entry (simulated for demo) -->
                <div id="otpEntry" class="hidden mb-6">
                    <p class="text-sm text-gray-600 mb-3" data-i18n="enterCustomerOtp">Le client doit entrer le code OTP re√ßu par SMS</p>
                    <div class="flex justify-center space-x-2">
                        <input type="text" maxlength="1" class="otp-input" oninput="handleCollectOtp(this, 0)" onkeydown="handleCollectOtpKeydown(event, 0)">
                        <input type="text" maxlength="1" class="otp-input" oninput="handleCollectOtp(this, 1)" onkeydown="handleCollectOtpKeydown(event, 1)">
                        <input type="text" maxlength="1" class="otp-input" oninput="handleCollectOtp(this, 2)" onkeydown="handleCollectOtpKeydown(event, 2)">
                        <input type="text" maxlength="1" class="otp-input" oninput="handleCollectOtp(this, 3)" onkeydown="handleCollectOtpKeydown(event, 3)">
                        <input type="text" maxlength="1" class="otp-input" oninput="handleCollectOtp(this, 4)" onkeydown="handleCollectOtpKeydown(event, 4)">
                        <input type="text" maxlength="1" class="otp-input" oninput="handleCollectOtp(this, 5)" onkeydown="handleCollectOtpKeydown(event, 5)">
                    </div>
                </div>
                
                <div class="flex space-x-3">
                    <button onclick="cancelCollection()" class="flex-1 py-3 border-2 border-gray-200 rounded-xl font-semibold text-gray-700">
                        <span data-i18n="cancel">Annuler</span>
                    </button>
                    <button id="simulateBtn" onclick="simulateOtpEntry()" class="flex-1 py-3 bg-purple-100 text-purple-700 rounded-xl font-semibold">
                        <span data-i18n="simulateOtp">Simuler OTP</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Step 2: USSD PIN Authorization Modal -->
    <div id="ussdModal" class="fixed inset-0 bg-black/50 hidden z-50 items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-md overflow-hidden slide-up">
            <div class="p-6 text-center">
                <!-- Step Indicator -->
                <div class="flex items-center justify-center space-x-2 mb-6">
                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-sm">
                        <i class="fas fa-check text-xs"></i>
                    </div>
                    <div class="w-8 h-1 bg-green-500"></div>
                    <div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center text-white text-sm font-bold">2</div>
                    <div class="w-8 h-1 bg-gray-200"></div>
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-gray-400 text-sm font-bold">
                        <i class="fas fa-check text-xs"></i>
                    </div>
                </div>
                
                <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-mobile-alt text-yellow-600 text-3xl"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800 font-display mb-2" data-i18n="step2Title">√âtape 2: Confirmation USSD</h2>
                <p class="text-gray-500 mb-2" data-i18n="ussdSent">Une demande USSD a √©t√© envoy√©e au client</p>
                <p class="font-bold text-gray-800 text-lg mb-4" id="ussdPhone">+237 6XX XXX XXX</p>
                
                <!-- USSD Simulation -->
                <div class="bg-gray-900 rounded-xl p-4 mb-6 text-left font-mono text-sm">
                    <p class="text-green-400 mb-2">üì± USSD Push Notification</p>
                    <p class="text-white mb-1">Paiement QUITUS Pay</p>
                    <p class="text-gray-400 mb-1">Marchand: Boutique Astrid</p>
                    <p class="text-yellow-400 mb-2" id="ussdAmount">Montant: 10,000 XAF</p>
                    <p class="text-white">Entrez votre PIN Mobile Money pour confirmer</p>
                    <div class="flex items-center mt-3 space-x-2">
                        <div class="flex-1 bg-gray-700 rounded px-3 py-2 text-white">****</div>
                        <span class="text-gray-400">PIN</span>
                    </div>
                </div>
                
                <!-- Status -->
                <div class="pending-pulse flex items-center justify-center space-x-2 text-orange-500 mb-6">
                    <i class="fas fa-clock"></i>
                    <span data-i18n="waitingPin">En attente de la saisie du PIN...</span>
                </div>
                
                <div class="flex space-x-3">
                    <button onclick="cancelUssd()" class="flex-1 py-3 border-2 border-gray-200 rounded-xl font-semibold text-gray-700">
                        <span data-i18n="cancel">Annuler</span>
                    </button>
                    <button onclick="simulatePinEntry()" class="flex-1 py-3 bg-purple-100 text-purple-700 rounded-xl font-semibold">
                        <span data-i18n="simulatePin">Simuler PIN</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black/50 hidden z-50 items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-md overflow-hidden slide-up">
            <div class="p-6 text-center">
                <div class="success-animation w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check text-green-600 text-4xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 font-display mb-2" data-i18n="paymentReceived">Paiement re√ßu!</h2>
                <p class="text-gray-500 mb-4" data-i18n="paymentReceivedDesc">Le client a approuv√© le paiement.</p>
                
                <!-- Receipt -->
                <div class="bg-gray-50 rounded-xl p-4 mb-6 text-left">
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-500" data-i18n="reference">R√©f√©rence</span>
                        <span class="font-mono font-bold" id="successRef">QPS-XXXX-XXXX</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-500" data-i18n="customer">Client</span>
                        <span class="font-medium" id="successPhone">+237 6XX XXX XXX</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500" data-i18n="amount">Montant</span>
                        <span class="font-bold text-green-600" id="successAmount">10,000 XAF</span>
                    </div>
                </div>
                
                <div class="flex space-x-3">
                    <button onclick="printReceipt()" class="flex-1 py-3 border-2 border-gray-200 rounded-xl font-semibold text-gray-700">
                        <i class="fas fa-print mr-2"></i>
                        <span data-i18n="print">Imprimer</span>
                    </button>
                    <button onclick="closeSuccessModal()" class="flex-1 py-3 bg-gradient-merchant text-white rounded-xl font-semibold">
                        <span data-i18n="done">Termin√©</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== i18n ====================
        const translations = {
            fr: {
                merchantPortal: "Portail Marchand",
                businessName: "Nom commercial",
                todayCollections: "Collectes aujourd'hui",
                transactions: "Transactions",
                today: "aujourd'hui",
                collectPayment: "Collecter un paiement",
                customerPhone: "T√©l√©phone du client",
                amountToCollect: "Montant √† collecter (XAF)",
                description: "Description (optionnel)",
                descriptionPlaceholder: "Ex: Achat de marchandises",
                requestPayment: "Demander le paiement",
                recentCollections: "Collectes r√©centes",
                viewAll: "Tout voir",
                declined: "Refus√©",
                home: "Accueil",
                activity: "Activit√©s",
                merchant: "Marchand",
                reports: "Rapports",
                settings: "Param√®tres",
                waitingApproval: "En attente d'approbation",
                otpSentToCustomer: "Un code OTP a √©t√© envoy√© au client",
                amount: "Montant",
                waitingCustomer: "En attente du client...",
                enterCustomerOtp: "Le client doit entrer le code OTP",
                cancel: "Annuler",
                simulateApproval: "Simuler approbation",
                paymentReceived: "Paiement re√ßu!",
                paymentReceivedDesc: "Le client a approuv√© le paiement.",
                reference: "R√©f√©rence",
                customer: "Client",
                print: "Imprimer",
                done: "Termin√©"
            },
            en: {
                merchantPortal: "Merchant Portal",
                businessName: "Business name",
                todayCollections: "Today's collections",
                transactions: "Transactions",
                today: "today",
                collectPayment: "Collect a payment",
                customerPhone: "Customer phone",
                amountToCollect: "Amount to collect (XAF)",
                description: "Description (optional)",
                descriptionPlaceholder: "Ex: Purchase of goods",
                requestPayment: "Request payment",
                recentCollections: "Recent collections",
                viewAll: "View all",
                declined: "Declined",
                home: "Home",
                activity: "Activity",
                merchant: "Merchant",
                reports: "Reports",
                settings: "Settings",
                waitingApproval: "Waiting for approval",
                otpSentToCustomer: "An OTP code was sent to the customer",
                amount: "Amount",
                waitingCustomer: "Waiting for customer...",
                enterCustomerOtp: "Customer must enter OTP code",
                cancel: "Cancel",
                simulateApproval: "Simulate approval",
                paymentReceived: "Payment received!",
                paymentReceivedDesc: "Customer approved the payment.",
                reference: "Reference",
                customer: "Customer",
                print: "Print",
                done: "Done"
            },
            es: {
                merchantPortal: "Portal Comerciante",
                businessName: "Nombre comercial",
                todayCollections: "Cobros de hoy",
                transactions: "Transacciones",
                today: "hoy",
                collectPayment: "Cobrar un pago",
                customerPhone: "Tel√©fono del cliente",
                amountToCollect: "Monto a cobrar (XAF)",
                description: "Descripci√≥n (opcional)",
                descriptionPlaceholder: "Ej: Compra de mercanc√≠as",
                requestPayment: "Solicitar pago",
                recentCollections: "Cobros recientes",
                viewAll: "Ver todo",
                declined: "Rechazado",
                home: "Inicio",
                activity: "Actividad",
                merchant: "Comerciante",
                reports: "Reportes",
                settings: "Ajustes",
                waitingApproval: "Esperando aprobaci√≥n",
                otpSentToCustomer: "Se envi√≥ un c√≥digo OTP al cliente",
                amount: "Monto",
                waitingCustomer: "Esperando al cliente...",
                enterCustomerOtp: "El cliente debe ingresar el c√≥digo OTP",
                cancel: "Cancelar",
                simulateApproval: "Simular aprobaci√≥n",
                paymentReceived: "¬°Pago recibido!",
                paymentReceivedDesc: "El cliente aprob√≥ el pago.",
                reference: "Referencia",
                customer: "Cliente",
                print: "Imprimir",
                done: "Listo"
            }
        };
        
        let currentLanguage = localStorage.getItem('quitusLang') || 'fr';
        
        function applyTranslations() {
            const t = translations[currentLanguage];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.textContent = t[key];
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (t[key]) el.placeholder = t[key];
            });
        }
        
        // ==================== Collection Data ====================
        let collectionData = { phone: '', amount: 0, description: '' };
        
        // ==================== Form Validation ====================
        function validateCollectForm() {
            const phone = document.getElementById('customerPhone').value;
            const amount = parseInt(document.getElementById('collectAmount').value) || 0;
            const btn = document.getElementById('collectBtn');
            
            btn.disabled = !(phone.length === 9 && amount >= 100);
        }
        
        // ==================== Collection Flow ====================
        // Step 1: Initiate collection - Send OTP to customer
        function initiateCollection() {
            collectionData.phone = document.getElementById('customerPhone').value;
            collectionData.amount = parseInt(document.getElementById('collectAmount').value);
            collectionData.description = document.getElementById('collectDescription').value || '-';
            
            // Update OTP modal (Step 1)
            document.getElementById('modalPhone').textContent = '+237 ' + formatPhone(collectionData.phone);
            document.getElementById('modalAmount').textContent = collectionData.amount.toLocaleString() + ' XAF';
            document.getElementById('modalDescription').textContent = collectionData.description;
            
            // Show OTP modal
            document.getElementById('otpModal').classList.remove('hidden');
            document.getElementById('otpModal').classList.add('flex');
            
            console.log('Step 1: Sending OTP to customer for identity verification:', collectionData.phone);
        }
        
        function cancelCollection() {
            document.getElementById('otpModal').classList.add('hidden');
            document.getElementById('otpModal').classList.remove('flex');
            resetOtpModal();
        }
        
        function cancelUssd() {
            document.getElementById('ussdModal').classList.add('hidden');
            document.getElementById('ussdModal').classList.remove('flex');
        }
        
        // Simulate customer entering OTP
        function simulateOtpEntry() {
            document.getElementById('pendingStatus').classList.add('hidden');
            document.getElementById('otpEntry').classList.remove('hidden');
            document.getElementById('simulateBtn').classList.add('hidden');
        }
        
        function handleCollectOtp(input, index) {
            input.value = input.value.replace(/\D/g, '');
            if (input.value.length === 1) {
                input.classList.add('filled');
                if (index < 5) {
                    document.querySelectorAll('#otpEntry .otp-input')[index + 1].focus();
                } else {
                    // All OTP digits entered - Move to Step 2 (USSD PIN)
                    goToUssdStep();
                }
            } else {
                input.classList.remove('filled');
            }
        }
        
        function handleCollectOtpKeydown(e, index) {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
                document.querySelectorAll('#otpEntry .otp-input')[index - 1].focus();
            }
        }
        
        // Step 2: OTP verified - Send USSD push for PIN authorization
        function goToUssdStep() {
            // Hide OTP modal
            document.getElementById('otpModal').classList.add('hidden');
            document.getElementById('otpModal').classList.remove('flex');
            
            // Update USSD modal
            document.getElementById('ussdPhone').textContent = '+237 ' + formatPhone(collectionData.phone);
            document.getElementById('ussdAmount').textContent = 'Montant: ' + collectionData.amount.toLocaleString() + ' XAF';
            
            // Show USSD modal (Step 2)
            document.getElementById('ussdModal').classList.remove('hidden');
            document.getElementById('ussdModal').classList.add('flex');
            
            console.log('Step 2: OTP verified. Sending USSD push to customer for PIN authorization');
        }
        
        // Simulate customer entering PIN on their phone
        function simulatePinEntry() {
            // Show loading briefly then success
            document.getElementById('ussdModal').classList.add('hidden');
            document.getElementById('ussdModal').classList.remove('flex');
            
            // Simulate processing time
            setTimeout(() => {
                processCollection();
            }, 1500);
        }
        
        // Step 3: PIN verified - Transaction complete
        function processCollection() {
            // Generate reference
            const ref = 'QPS-' + Math.random().toString(36).substring(2, 6).toUpperCase() + '-' + Math.random().toString(36).substring(2, 6).toUpperCase();
            
            // Update success modal
            document.getElementById('successRef').textContent = ref;
            document.getElementById('successPhone').textContent = '+237 ' + formatPhone(collectionData.phone);
            document.getElementById('successAmount').textContent = collectionData.amount.toLocaleString() + ' XAF';
            
            // Show success modal
            document.getElementById('successModal').classList.remove('hidden');
            document.getElementById('successModal').classList.add('flex');
            
            // Reset form
            document.getElementById('customerPhone').value = '';
            document.getElementById('collectAmount').value = '';
            document.getElementById('collectDescription').value = '';
            validateCollectForm();
            
            // Reset OTP modal state
            resetOtpModal();
            
            console.log('Step 3: Transaction complete! Reference:', ref);
        }
        
        function resetOtpModal() {
            document.getElementById('pendingStatus').classList.remove('hidden');
            document.getElementById('otpEntry').classList.add('hidden');
            document.getElementById('simulateBtn').classList.remove('hidden');
            document.querySelectorAll('#otpEntry .otp-input').forEach(input => {
                input.value = '';
                input.classList.remove('filled');
            });
        }
        
        function closeSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
            document.getElementById('successModal').classList.remove('flex');
        }
        
        function printReceipt() {
            window.print();
        }
        
        // ==================== Utility Functions ====================
        function formatPhone(phone) {
            return phone.replace(/(\d{3})(\d{3})(\d{3})/, '$1 $2 $3');
        }
        
        function goBack() {
            window.location.href = 'quitus_pay_home_v2.html';
        }
        
        // ==================== Initialize ====================
        document.addEventListener('DOMContentLoaded', function() {
            applyTranslations();
            
            document.getElementById('customerPhone').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 9) value = value.slice(0, 9);
                e.target.value = value;
            });
        });
    </script>
</body>
</html>
